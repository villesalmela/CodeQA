{% extends 'base.html.j2' %}
{% block head %}
{% include 'load_jquery.html' %}
{% include 'load_ace.html' %}
{% include 'load_datatables.html' %}
<script src="/static/functions.js"></script>
{% endblock %}
{% block title %}Code QA{% endblock %}
{% block body %}
<h1>Add new function</h1>
<nav class="trail">
    <ul>
        <li><strong>Check</strong></li>
        <li>Document</li>
        <li>Test</li>
        <li>Classify</li>
    </ul>
</nav>
<h1>Static Checking</h1>
{% include 'error_form.html.j2' %}
{% if error %}
<p class="error-message">{{ error }}</p>
{% endif %}
<form id="form" method="POST" action="/add">
    {{ form.csrf_token }}
    <label for="editor_box" class="subtitle">Source Code</label><br>
    <div id="editor_box" class="editor-box"></div>
    <input type="hidden" id="code" name="code">
    {{ form.run }} {{ form.doc }}
</form>
<script nonce="{{ csp_nonce() }}">
    setSpinner("form")
    addEditor("editor_box", {{ form.code.data | tojson }}, "code")
</script>
{% if lint_result is defined %}
<h2>Linting Results</h2>
{% if lint_result|length > 0 %}
<p>Click on a row to highlight the relevant part in code window. Click on an ID number to view more details about the
    issue.
    Feel free to make adjustments in the source code and run the linting again.</p>
<table id="lint-results">
    <thead>
        <tr>
            <th>Type</th>
            <th>ID</th>
            <th>Message</th>
            <th>Object</th>
            <th>Line</th>
            <th hidden>Startcolumn</th>
            <th hidden>Endline</th>
            <th hidden>Endcolumn</th>
        </tr>
    </thead>
    <tbody>
        {% for item in lint_result %}
        <tr>
            <td>{{ item.type }}</td>
            <td><a target="_blank" rel="noreferrer noopener" href="{{ item.link }}">{{ item["message-id"] }}</a></td>
            <td>{{ item.message }}</td>
            <td>{{ item.obj }}</td>
            <td>{{ item.line }}</td>
            <td hidden>{{ item.column }}</td>
            <td hidden>{{ item.endLine }}</td>
            <td hidden>{{ item.endColumn }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<script nonce="{{ csp_nonce() }}">
    // highlight code when related row is clicked
    addRowHandler("lint-results", pylintRowClicked)
    
    // apply datatables script to linting results
    makeDatatable("lint-results")
</script>


<div id="lint_box" class="editor-box"></div>
<script nonce="{{ csp_nonce() }}">
    // add editor box for linting results
    addEditor("lint_box", {{ form.code.data | tojson }}, null, parse_lint_results())
</script>

{% else %}
<p>No errors or warnings.</p>
{% endif %}
{% endif %}
{% if security_result is defined %}
<h2>Bandit Results</h2>
{% if security_result|length > 0 %}
<p>Click on a row to highlight the relevant part in code window. Click on an ID number to view more details about the
    issue.
    Feel free to make adjustments in the source code and run the check again.</p>
<table id="security-results">
    <thead>
        <tr>
            <th>Test</th>
            <th>ID</th>
            <th>Message</th>
            <th>Severity</th>
            <th>Confidence</th>
            <th>Object</th>
            <th>Weakness</th>
            <th>Line</th>
            <th hidden>Startcolumn</th>
            <th hidden>Endline</th>
            <th hidden>Endcolumn</th>
        </tr>
    </thead>
    <tbody>
        {% for item in security_result %}
        <tr>
            <td>{{ item.test }}</td>
            <td><a target="_blank" rel="noreferrer noopener" href="{{ item.test_link }}">{{ item.test_id }}</a></td>
            <td>{{ item.description }}</td>
            <td>{{ item.severity }}</td>
            <td>{{ item.confidence }}</td>
            <td>{{ item.object }}</td>
            <td><a target="_blank" rel="noreferrer noopener" href="{{ item.cwe_link }}">CWE-{{ item.cwe_id }}</a></td>
            <td>{{ item.line }}</td>
            <td hidden>{{ item.col }}</td>
            <td hidden>{{ item.line_end }}</td>
            <td hidden>{{ item.col_end }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<script nonce="{{ csp_nonce() }}">
    // highlight code when related row is clicked
    addRowHandler("security-results", banditRowClicked)
    
    // apply datatables script to security results
    makeDatatable("security-results")
</script>


<div id="security_box" class="editor-box"></div>
<script nonce="{{ csp_nonce() }}">
    // add editor box for security results
    addEditor("security_box", {{ form.code.data | tojson }}, null, parse_security_results())
</script>

{% else %}
<p>No errors or warnings.</p>
{% endif %}
{% endif %}
{% endblock %}